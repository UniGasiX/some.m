# SNMN 格式文件处理包

该文件夹下包含多个与解析 SNMN 格式文件有关的函数。

## SNMN 格式

该格式由简谱简化而来，其文件实质是文本文件，由一连串 ASCII 字符组成。在该格式中，以下15个字符是具有指定意义的：

```text
- + # b 0 1 2 3 4 5 6 7 ~ _ . %
```

其他字符将在解析时将被忽略。

该格式描述的乐音由一连串指定音高和节拍数的音简单连接组成，音高只支持由十二平均律规定的标准音高。每个音的标记以标记音高的字符为中心，前后分别可选的加上前缀及后缀。如：

```text
+#5_.
```

该标记表示一个音高为C调高音5#，拍数为3/4拍的音。其中，“```+#```”部分是前缀，对音高进行进一步的指定；“```5```”部分是音高符号；“```_.```”部分是后缀，指示该音的长度即拍数。根据描述需要，前缀和后缀可以不需要，但是前缀符号不可以出现在后缀中，后缀符号亦不应出现在前缀中。

### 字符的指定意义

以下根据前后缀和音高符号分别解释每个字符的指定意义。

> *P.S.：区分前后缀似乎是个没必要的设计，但是这是我刚开始尝试想法可行性时设定的设计，懒得改了，原本的意图是为了“增加一点可读性”（实际上降低了可读性并提高了解析复杂度……）。*

#### 音高符号

音高以C调音高为基准。

- 0 ：休止符，可对该“音高符号”施加前缀，但应被忽略；
- 1 ：do，具体音高由前缀决定；
- 2 ：re，具体音高由前缀决定；
- 3 ：mi，具体音高由前缀决定；
- 4 ：fa，具体音高由前缀决定；
- 5 ：sol，具体音高由前缀决定；
- 6 ：la，具体音高由前缀决定；
- 7 ：si，具体音高由前缀决定。

#### 前缀

- \- （减号）：每出现一个该符号将当前的音降七个音。相当于简谱中音符下方的点；
- \+ （加号）：每出现一个该符号将当前的音升七个音。相当于简谱中音符上方的点；
- \# （井号）：……，相当于简谱中音符左上角的升号；
- b （小写字母b）：……，相当于简谱中音符左上角的降号。

#### 后缀

- ~ （波浪号（？））：每出现一个该符号将当前音当前长度延长一拍。相当于简谱中音符后的短横线；
- _ （下划线）：每出现一个该符号将当前音当前长度缩短一半。相当于简谱中音符下的横线；
- . （英文句点）：每出现一个该符号将当前音当前长度延长当前长度的一半。相当于简谱中音符右边的点。

#### 特殊符号

- % （百分号）：解析终止标记，对文件的解析将在遇到该字符后立即结束，忽略文件剩余所有内容。

### 音的组合

每个音的符号直接按顺序简单连接在一起，不设分隔符。

### 解析

解析从文件开头开始，至文件结尾或解析终止符号（%）结束，逐字符解析。每个音定为从前缀或音高符号开始，至下一个音的开始结束。文件中所有非本格式指定了意义的符号都将被忽略。前缀和后缀的特殊情况处理如下所述：

- 若前缀出现多个 ```-``` 和 ```+``` ，最终结果由它们的影响累加得到，即 ```-++``` 相当于 ```+``` 。
- 若前缀出现多个 ```#``` 和 ```b``` ，最终结果由它们中最后出现的一个决定，即 ```##b#b``` 相当于 ```b``` 。
- 后缀中各符号最终施加的影响由它们本身规定施加的影响顺次累积得到，即 ```~_._~```指示的音长为 ((((1 ```+1```) ```/2```) ```*1.5```) ```/2```) ```+1``` = 1.75 拍。

## 储存单音信息的struct

在当前版本中，SNMN格式文件会被先解析成一系列表示单个音信息的struct。该struct包含以下字段：

- note：音高符号，以数字而非字符形式指定。
- lh：指示相对C调降低或升高几个7个音。升高为正，降低为负，不变为0。
- half：指示升或降半个音。升为1，将为-1，不升降为0。
- dura：该音的拍数。

## 生成单音声音的函数

当前版本中，声音的生成被拆解为对每个单音的生成和各单音按顺序简单连接两个步骤。需要一个函数能给定单音的信息后生成对应声音。该函数的参数与返回值设置应遵照如下规则：

该函数的前四个参数按顺序应为表示一个音的struct、一拍以秒为单位的实际时长、采样频率和一个储存临时数据的结构体，返回生成的声音信号单行矩阵和一个储存临时数据的结构体。